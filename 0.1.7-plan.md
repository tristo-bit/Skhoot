# Skhoot 0.1.7: Enterprise Safety & Structured Execution

## Goal
Transition from the current "Interactive Co-pilot" (Live PTY) model to a "Safe Autonomous Agent" architecture inspired by `codex-main`. This update focuses on safety, determinism, and granular control over the AI's system access.

## Core Abstractions to Implement

### 1. Execution Policy (`ExecPolicy`)
**Why:** To prevent accidental destruction and unauthorized access.
*   **Safe/Unsafe Classification:** Automatically detect potentially dangerous commands (`rm`, `dd`, `chmod`).
*   **Approval Workflow:**
    *   **Auto-Allow:** `ls`, `grep`, `cat` run instantly.
    *   **Require Approval:** `npm install`, `cargo build` might prompt.
    *   **Critical Block:** `rm -rf /` or `sudo` requires explicit confirmation with justification.

### 2. Command Specification (`CommandSpec`)
**Why:** To ensure execution is deterministic and debuggable.
*   Encapsulate all execution parameters: `cwd`, `env`, `timeout`, `permissions`.
*   Decouple the *intent* ("list files") from the *mechanism* ("exec /bin/ls").
*   Enable better logging and audit trails.

### 3. Structured Output Streams
**Why:** To solve race conditions and parsing ambiguity.
*   Replace the global PTY output buffer with per-execution `StdoutStream` and `StderrStream`.
*   Reliably capture Exit Codes for every command.
*   Prevent "output bleeding" where the result of Command A is confused with Command B.

### 4. Sandboxing (Future Scope)
*   Run commands in isolated environments (containers or restricted shells) by default.
*   Allow "Escalation" requests where the AI asks to break out of the sandbox.

## Migration Path
1.  **Refactor Executor:** Introduce `ToolOrchestrator` to manage the lifecycle of a tool call (Request -> Policy Check -> Approval -> Execution).
2.  **Implement Policy Layer:** Create the `is_safe_command` logic.
3.  **UI Updates:** Add "Approval Request" cards in the chat stream for blocked commands.

## Benefit
This transforms Skhoot from a powerful power-user tool into a trusted platform that can be left running unsupervised without fear of it destroying the system.
